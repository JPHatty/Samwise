{
  "$schema": "http://json-schema.org/draft-07/schema#",
  "$id": "https://github.com/JPHatty/Samwise/schemas/tool-spec.schema.json",
  "title": "Tool Specification",
  "description": "Machine-usable declaration of a tool/workflow that can be executed. Must be sufficient to execute WITHOUT interpretation.",
  "type": "object",
  "required": [
    "tool_id",
    "version",
    "description",
    "input_schema",
    "output_schema",
    "execution_mode",
    "credentials_required",
    "side_effects",
    "rollback_strategy",
    "timeout_seconds",
    "resource_class"
  ],
  "additionalProperties": false,
  "properties": {
    "tool_id": {
      "type": "string",
      "pattern": "^[a-z0-9_-]+$",
      "description": "Stable identifier for this tool (lowercase, alphanumeric, hyphens, underscores)"
    },
    "version": {
      "type": "string",
      "pattern": "^(0|[1-9]\\d*)\\.(0|[1-9]\\d*)\\.(0|[1-9]\\d*)(?:-((?:0|[1-9]\\d*|\\d*[a-zA-Z-][0-9a-zA-Z-]*)(?:\\.(?:0|[1-9]\\d*|\\d*[a-zA-Z-][0-9a-zA-Z-]*))*))?(?:\\+([0-9a-zA-Z-]+(?:\\.[0-9a-zA-Z-]+)*))?$",
      "description": "Semantic version (semver) of this tool specification"
    },
    "description": {
      "type": "string",
      "minLength": 10,
      "maxLength": 500,
      "description": "Concise description of what this tool does"
    },
    "input_schema": {
      "type": "object",
      "description": "JSON Schema defining valid inputs (must be a complete JSON Schema object)",
      "required": ["type"],
      "properties": {
        "type": {
          "type": "string"
        }
      }
    },
    "output_schema": {
      "type": "object",
      "description": "JSON Schema defining expected outputs (must be a complete JSON Schema object)",
      "required": ["type"],
      "properties": {
        "type": {
          "type": "string"
        }
      }
    },
    "execution_mode": {
      "type": "string",
      "enum": ["local", "remote", "browser"],
      "description": "Where this tool executes"
    },
    "credentials_required": {
      "type": "array",
      "description": "Array of credential IDs (not the secrets themselves) needed to execute",
      "items": {
        "type": "string",
        "pattern": "^[A-Z0-9_]+$",
        "examples": ["GITHUB_TOKEN", "SUPABASE_KEY", "N8N_API_KEY"]
      },
      "uniqueItems": true
    },
    "side_effects": {
      "type": "array",
      "description": "Explicit declaration of all side effects this tool may cause",
      "items": {
        "type": "object",
        "required": ["effect_type", "description", "reversible"],
        "additionalProperties": false,
        "properties": {
          "effect_type": {
            "type": "string",
            "enum": [
              "file_write",
              "file_delete",
              "network_request",
              "state_mutation",
              "service_restart",
              "database_write",
              "credential_access",
              "log_generation"
            ]
          },
          "description": {
            "type": "string",
            "minLength": 1
          },
          "reversible": {
            "type": "boolean",
            "description": "Whether this side effect can be undone"
          },
          "scope": {
            "type": "string",
            "description": "What is affected (e.g., file path, service name, database table)"
          }
        }
      }
    },
    "rollback_strategy": {
      "type": "string",
      "enum": ["none", "compensating", "snapshot"],
      "description": "How to undo execution if needed"
    },
    "timeout_seconds": {
      "type": "integer",
      "minimum": 1,
      "maximum": 3600,
      "description": "Maximum execution time in seconds (bounded: 1-3600)"
    },
    "resource_class": {
      "type": "string",
      "enum": ["control", "compute", "state"],
      "description": "Primary resource type this tool operates on"
    },
    "dependencies": {
      "type": "object",
      "description": "External dependencies required for execution",
      "additionalProperties": false,
      "properties": {
        "tools": {
          "type": "array",
          "description": "Other tool IDs that must be available",
          "items": {
            "type": "string"
          }
        },
        "services": {
          "type": "array",
          "description": "Services that must be running",
          "items": {
            "type": "string",
            "enum": ["n8n", "redis", "livekit", "traefik"]
          }
        },
        "minimum_resources": {
          "type": "object",
          "additionalProperties": false,
          "properties": {
            "memory_mb": {
              "type": "integer",
              "minimum": 0
            },
            "cpu_cores": {
              "type": "number",
              "minimum": 0
            },
            "disk_mb": {
              "type": "integer",
              "minimum": 0
            }
          }
        }
      }
    },
    "validation": {
      "type": "object",
      "description": "How to validate tool execution",
      "additionalProperties": false,
      "properties": {
        "pre_conditions": {
          "type": "array",
          "description": "Conditions that must be true before execution",
          "items": {
            "type": "string"
          }
        },
        "post_conditions": {
          "type": "array",
          "description": "Conditions that must be true after execution",
          "items": {
            "type": "string"
          }
        },
        "invariants": {
          "type": "array",
          "description": "Conditions that must remain true throughout execution",
          "items": {
            "type": "string"
          }
        }
      }
    },
    "metadata": {
      "type": "object",
      "description": "Optional metadata",
      "additionalProperties": true,
      "properties": {
        "author": {
          "type": "string"
        },
        "created_at": {
          "type": "string",
          "format": "date-time"
        },
        "updated_at": {
          "type": "string",
          "format": "date-time"
        },
        "tags": {
          "type": "array",
          "items": {
            "type": "string"
          }
        }
      }
    }
  }
}
